<!DOCTYPE html>
<html>
<head>
	<link rel="stylesheet" href="w3.css">
	<title>Caffe Installation</title>

</head>

<body>

<h1>An Easy Way to Install Caffe with Gpu-Support in Ubuntu-16.04</h1>
<hr>
<h2>Important Note</h2>
<p>All the changes in gcc are required if system default is gcc-6.x or above, which appears in Ubuntu-17.<br>
If Ubuntu-16.04 has gcc-5.4 by default, one can ignore all steps concerning gcc configuration.<br></p>

<h2>Step-1 Install latest Nvidia-graphics driver</h2>
<p>
One nice working method is to do this in Ubuntu is to install via Additional Driver option in Software Settings.
</p>
<hr>


<h2>Step-2 Change default gcc version to 4.8 or 4.9</h2>
<div>
<em>
sudo update-alternatives --remove-all gcc<br>
sudo update-alternatives --remove-all g++<br>
<br>
sudo apt-get install gcc-4.9 g++-4.9<br>
<br>
sudo update-alternatives --install /usr/bin/gcc gcc /usr/bin/gcc-4.9 10<br>
sudo update-alternatives --install /usr/bin/g++ g++ /usr/bin/g++-4.9 10<br>
</em>
</div>
<p>
This will make gcc-4.9 your default gcc version required to install CUDA correctly.
</p>
<hr>

<h2>Step-3 Install CUDA-8.0</h2>
<p>
Among many options available I prefer using local installation via .deb package as follow:-
</p>
<div><em>
sudo dpkg -i cuda****.deb<br>
sudo apt update<br>
sudo apt install cuda<br>
</em>
</div>
<p>
After installation add Cuda to path of the system.
To do this open .bashrc file in home directory with admin privileges and in the end of the file append following:-
</p>
<div>
<em>
export CUDA_HOME=/usr/local/cuda-8.0<br>
export LD_LIBRARY_PATH=${CUDA_HOME}/lib64 <br>
PATH=${CUDA_HOME}/bin:${PATH} <br>
export PATH<br>
</em>
</div>
<p>
Reopen the terminal and check the installation of cuda by running following command in terminal:-
</p>
<div>
<em> nvcc -v </em>
</div>
<hr>


<h2>Step-4 Install Nvidia's CuDNN deep learning library</h2>
<p>
Go to nvidia's site and login with developer account(if you don't have it by now,then make one).
Download CuDNN version 5.1 for Cuda-8.0
Extract the .tgz and copy content inside it to Cuda directories as follow:-
<div>
<em>
sudo cp -P include/cudnn.h /usr/include<br>
sudo cp -P lib64/libcudnn* /usr/lib/x86_64-linux-gnu/<br>
sudo chmod a+r /usr/lib/x86_64-linux-gnu/libcudnn*<br>
</em>
</div>
</p>
<hr>


<h2>Step-5 Install various dependencies</h2>
<p>
Several packages are required for installing Caffe. They are also listed at <a href = "http://caffe.berkeleyvision.org/install_apt.html">official site of Caffe</a>.
But for your comfort I've added them here.
<div><em>
sudo apt-get install libprotobuf-dev libleveldb-dev libsnappy-dev libopencv-dev libhdf5-serial-dev protobuf-compiler<br>
sudo apt-get install --no-install-recommends libboost-all-dev<br>
sudo apt-get install the python-dev<br>
sudo apt-get install libgflags-dev libgoogle-glog-dev liblmdb-dev<br>
sudo pip install protobuf<br>
sudo apt install libopenblas-dev<br>
</em>
</div>

</p>
<hr>


<h2>Step-6 Here comes the trick part</h2>
<p>
Several libraries required for caffe such as <em>google-glog</em> and <em>libboost </em> do not work with anything lower than gcc-5, but remember CUDA-8.0 doens't work with gcc-5 yet. So, we have to install gcc-5 now.
<div><em>
sudo add-apt-repository ppa:ubuntu-toolchain-r/test<br>

sudo apt-get update<br>

sudo apt-get install gcc-5 g++-5<br>

</em>
</div>
<br>
Now we need to do three things-<br>
<b><em>[1]</em> Make gcc-5 as default gcc compiler so that we do not get error while compiling caffe</b><br>.
<div><em>
sudo update-alternatives --install /usr/bin/gcc gcc /usr/bin/gcc-5 20<br>
sudo update-alternatives --install /usr/bin/g++ g++ /usr/bin/g++-5 20<br>
sudo update-alternatives --config gcc<br>
sudo update-alternatives --config g++<br>


</em>
</div>
<br>
<b><em>[2]</em> Change CUDA configuration to do not give error with gcc-5 compiler</b><br>
<p> Find cuda_config.h file in cuda installation directory and comment the line which indiacte error with gcc-5 compiler.<br>

<br>
<b><em>[3]</em> Install python-numpy</b><br>
Glitch is that Numpy library installed with "pip" gives error at time of compilation for some reasons I do not have will to undersatnd. Easy way to handle this is remove numpy installed via pip and install python-numpy.<br>
<div><em>
sudo pip uninstall numpy<br>
sudo apt install python-numpy<br>

</em></div>
</p>
<hr>


<h2>Step-7 Download Caffe</h2>
<p>
One can download caffe as .zip file from <a href="https://github.com/BVLC/caffe">Official Caffe Github Repository</a>, or you can just clone it.
</p>
<div><em>
git clone https://github.com/BVLC/caffe.git<br>
</em>
</div>
<hr>


<h2>Step-8 Wait! You will need a Makefile.</h2>
<p>
Now we need to make a <em>Makefile.config file</em>. Instructions are given here<em> <a href="http://caffe.berkeleyvision.org/installation.html#compilation">Caffe compilation on Caffe website</a></em>.But you need to configure it as per your system's requirement. But to make it easy here is the link for my <a href = "https://github.com/sachinumrao/caffe"> <em>Makefile.config</em></a> file. The major changes are as following:-<br>
<ul>
<li> Path for many libraries are added</li>
<li> CuDNN is uncommented to use CUDA </li>
<li> path to gcc-5 compiler is given </li>
</ul><br>
(one may actually need to change adresses to various libraries a liitle bit according to paths in their system, but if you closely follow this guide, chances are you will not require any changes. Another doubt that may arise is that we already added gcc-5 as system default then why do we need to give gcc-5 path in Makefile.config. The answer is while compiling Caffe some libraries require gcc but they are not able to find it. Providing gcc-5 path in Makefile.config solves this issue.)<br>
Now copy the downloaded <em>Makefile.config</em> inside the newly formed Caffe folder and proceed to step 9.<br>
</p>
<hr>


<h2>Step-9 Compile</h2>
<p>
Go inside the Caffe folder and execute following commands:-
<div>
<em>
make all<br>
make test<br>
make runtest<br>
make pycaffe<br>
</em>

</div>

</p>
<hr>


<h2>Step-10 Add Python path</h2>
<p>
Again open our beloved .bashrc with admin privileges and append following:-
<div>
<em>
export PYTHONPATH=/home/your_username/path_to_caffe/python:$PYTHONPATH
</em>
</div>
</p>
<hr>


<h2>Tasting the Caffe</h2>
<p>
Open python interpreter or jupyter notebook and run:-
</p>
<div>
<em>
import caffe
</em>
</div>
If you don't get any error messages, I believe you are as lucky as I am and you Caffe is brewed well. A good enough reason to celebrate. Cheers!!!


<h2> Acknowledgements</h2>
<ul>
<li> <a href="https://github.com/BVLC/caffe/wiki/Ubuntu-16.04-or-15.10-Installation-Guide">Ubuntu-16.04-or-15.10-Installation-Guide</a></li>
<li> Countless Caffe github issue pages of which I have not kept any record.</li>
</ul><br>
In the end Thank You! for bearing with me.
</body>


</html>
